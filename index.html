<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TopsOffer Thailand - Pop Secret Popcorn</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#fafafa; color:#111; }
    header { background:#232f3e; color:#fff; padding:15px; text-align:center; font-size:20px; font-weight:bold; }
    .container { max-width:980px; margin:20px auto; padding:15px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.06); border:1px solid #e3e6e6; border-radius:8px; }
    .grid { display:flex; flex-wrap:wrap; gap:24px; }
    .gallery { flex:1 1 340px; text-align:center; }
    .gallery img { max-width:100%; border:1px solid #ddd; border-radius:8px; }
    .details { flex:1 1 460px; }
    .price { font-size:24px; color:#b12704; margin:8px 0 4px; }
    .meta { color:#444; margin-bottom:8px; }
    .kpis { display:flex; gap:16px; flex-wrap:wrap; margin:10px 0 14px; }
    .kpi { background:#f7f7f7; border:1px solid #e3e6e6; padding:8px 12px; border-radius:8px; font-size:14px; }
    .badge { display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:bold; margin-right:8px; }
    .badge.in { background:#e8f5f1; color:#067d62; border:1px solid #c7eee4; }
    .badge.low { background:#fdecea; color:#b12704; border:1px solid #facdca; }
    .bullets { margin:10px 0 16px; padding-left:18px; }
    .panel { background:#fafbfd; border:1px solid #e3e6e6; border-radius:10px; padding:12px 14px; margin-top:12px; }
    .row { display:flex; align-items:center; gap:10px; margin:10px 0; }
    label { display:block; font-weight:600; margin:10px 0 6px; }
    input, textarea { width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:15px; }
    .qty input { width:70px; text-align:center; }
    .btn { border:none; border-radius:999px; padding:12px 16px; font-weight:700; cursor:pointer; }
    .btn-primary { background:#ffd814; }
    .btn-secondary { background:#ffa41c; }
    .btn:active { transform: translateY(1px); }
    .summary { margin-top:12px; border-top:1px dashed #e3e6e6; padding-top:12px; }
    .sum-row { display:flex; justify-content:space-between; margin:4px 0; font-size:14px; }
    .sum-total { font-weight:800; font-size:16px; margin-top:6px; }
    .free { color:#067d62; font-weight:700; }
    .qrcode { text-align:center; margin-top:14px; }
    .ok { color:#067d62; margin-top:8px; }
    .err { color:#b12704; margin-top:8px; white-space:pre-wrap; }
    .shipbar { max-width:980px; margin:12px auto 0; background:#0a6a58; color:#fff; padding:10px 12px; border-radius:8px; text-align:center; font-weight:700; box-shadow:0 0 0 3px rgba(14,124,102,.15) inset; }
    .muted { color:#666; font-size:13px; }
    footer { text-align:center; padding:16px; color:#666; }
    @media (max-width: 860px){ .grid { flex-direction:column; } }
  </style>
</head>
<body>
  <header>TopsOffer Thailand</header>

  <div class="shipbar">üöö ‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ‡∏ó‡∏∏‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå <span class="muted">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</span></div>

  <div class="container">
    <div class="grid">
      <div class="gallery">
        <img id="mainImg" src="https://i.ibb.co/9kvfpgzg/166578-0.jpg" alt="Pop Secret Popcorn">
      </div>

      <div class="details">
        <h1>Pop Secret Popcorn Movie Theater Butter 588g</h1>
        <div class="meta">Ships from Thailand | Sold by TopsOffer Thailand</div>
        <div class="price">‡∏ø<span id="unitPrice">1299</span> / ‡∏Å‡∏•‡πà‡∏≠‡∏á</div>
        <div>
          <span id="stockBadge" class="badge in">‚úî In stock</span>
          <span>‡∏Ñ‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π: <b id="viewers">25</b></span>
        </div>

        <div class="kpis">
          <div class="kpi">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <b id="salesToday">12</b></div>
          <div class="kpi">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏õ‡∏£‡∏Ø: <b id="countdown">--:--:--</b></div>
        </div>

        <ul class="bullets">
          <li>‡∏Å‡∏•‡∏¥‡πà‡∏ô‡πÄ‡∏ô‡∏¢‡∏´‡∏≠‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÇ‡∏£‡∏á‡∏´‡∏ô‡∏±‡∏á</li>
          <li>‡πÅ‡∏û‡πá‡∏Ñ‡πÉ‡∏´‡∏ç‡πà 588g ‡∏™‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°</li>
          <li>‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÄ‡∏ß‡∏ü 2‚Äì3 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏¥‡∏ô</li>
          <li>‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏î‡∏π‡∏´‡∏ô‡∏±‡∏á & ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ</li>
        </ul>

        <div class="panel">
          <div class="row qty">
            <label for="qty">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3)</label>
            <input id="qty" type="number" min="1" max="3" value="1">
          </div>

          <div class="summary">
            <div class="sum-row"><span>‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span> <span>‡∏ø<span id="sumItems">1299</span></span></div>
            <div class="sum-row"><span>‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</span> <span class="free">‡∏ü‡∏£‡∏µ</span></div>
            <div class="sum-row sum-total"><span>‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span> <span>‡∏ø<span id="sumGrand">1299</span></span></div>
          </div>

          <div class="row" style="gap:12px;">
            <button class="btn btn-secondary" id="btnBuyNow">Buy Now</button>
            <button class="btn btn-primary" id="btnPay">Pay with PromptPay</button>
          </div>

          <form id="orderForm" style="margin-top:10px;">
            <label for="name">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
            <input id="name" name="name" required placeholder="‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
            <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
            <input id="phone" name="phone" required placeholder="08xxxxxxxx">
            <label for="address">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
            <textarea id="address" name="address" required placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏ñ‡∏ô‡∏ô/‡πÅ‡∏Ç‡∏ß‡∏á/‡πÄ‡∏Ç‡∏ï/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå"></textarea>
          </form>

          <div class="muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏£‡πå PromptPay ‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
          <div id="qrcode" class="qrcode"></div>
          <div id="ok" class="ok" style="display:none;"></div>
          <div id="err" class="err" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <footer>¬© 2025 TopsOffer Thailand</footer>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script>
    // ===== Config =====
    const EMAILJS_PUBLIC_KEY = 'UaGsOS23RWVTmDwAn';
    const EMAILJS_SERVICE_ID = 'service_topsoffer';
    const EMAILJS_TEMPLATE_ID = 'template_topsoffer';
    const EMAIL_TO = 'officialvoucher@gmail.com';

    const PRODUCT_NAME = 'Pop Secret Popcorn Movie Theater Butter 588g';
    const UNIT_PRICE = 1299;

    // PromptPay
    const PROMPTPAY_MOBILE = '0866292379';     // ‡∏´‡∏£‡∏∑‡∏≠
    const PROMPTPAY_NATIONAL_ID = '5110100025854';
    const PROMPTPAY_USE = 'mobile'; // 'mobile' or 'nid'

    // Stock/limit
    const ENFORCE_STOCK = false; // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á true
    let INVENTORY = 9999;

    // ===== Live UI =====
    let viewers = Math.floor(Math.random()*10)+18;
    let salesToday = Math.floor(Math.random()*8)+12;
    document.getElementById('viewers').textContent = viewers;
    document.getElementById('salesToday').textContent = salesToday;

    // countdown ‡∏ñ‡∏∂‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô
    const promoEnd = (()=>{ const n = new Date(); return new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,59); })();
    function tickCountdown(){
      const now = new Date();
      let d = Math.max(0, promoEnd - now);
      const h = String(Math.floor(d/3600000)).padStart(2,'0'); d%=3600000;
      const m = String(Math.floor(d/60000)).padStart(2,'0'); d%=60000;
      const s = String(Math.floor(d/1000)).padStart(2,'0');
      document.getElementById('countdown').textContent = `${h}:${m}:${s}`;
    }
    setInterval(()=>{ // viewers/sales random
      const delta = Math.floor(Math.random()*5)-2;
      viewers = Math.min(48, Math.max(8, viewers + delta));
      document.getElementById('viewers').textContent = viewers;
      if(Math.random()<0.25){ salesToday += 1; document.getElementById('salesToday').textContent = salesToday; }
    }, 6000);
    setInterval(tickCountdown, 1000); tickCountdown();

    // Qty & totals
    const qtyEl = document.getElementById('qty');
    const sumItemsEl = document.getElementById('sumItems');
    const sumGrandEl = document.getElementById('sumGrand');
    function clampQty(v){ return Math.min(3, Math.max(1, v)); } // ‡∏à‡∏≥‡∏Å‡∏±‡∏î 3 ‡∏ä‡∏¥‡πâ‡∏ô/‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
    function updateTotals(){
      const q = clampQty(parseInt(qtyEl.value||'1'));
      qtyEl.value = q;
      const items = q * UNIT_PRICE;
      sumItemsEl.textContent = items;
      sumGrandEl.textContent = items;
    }
    qtyEl.addEventListener('input', updateTotals);
    qtyEl.addEventListener('change', updateTotals);
    updateTotals();

    // ===== Helpers =====
    function makeOrderId(){
      const d = new Date(); const pad = n=>String(n).padStart(2,'0');
      return `TP-${d.getFullYear().toString().slice(2)}${pad(d.getMonth()+1)}${pad(d.getDate())}${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}-${Math.random().toString(36).slice(-4).toUpperCase()}`;
    }
    function tlv(id, value){ const len=value.length; return id + String(len).padStart(2,'0') + value; }
    function crc16(str){
      let crc=0xFFFF; for(let i=0;i<str.length;i++){ crc ^= str.charCodeAt(i)<<8; for(let j=0;j<8;j++){ crc = (crc & 0x8000) ? ((crc<<1)^0x1021):(crc<<1); crc &= 0xFFFF; } }
      return crc.toString(16).toUpperCase().padStart(4,'0');
    }
    function buildPromptPayPayload(acc, amount){
      const isNatId = /^\d{13}$/.test(acc), isPhone = /^0\d{9}$/.test(acc);
      let proxy=''; if(isPhone){ proxy='66'+acc.substring(1); } else if(isNatId){ proxy=acc; } else { throw new Error('Invalid PromptPay ID'); }
      const gui='A000000677010111', mai=tlv('00',gui)+tlv(isPhone?'01':'02',proxy), maiAll=tlv('29',mai);
      const payload=tlv('00','01')+tlv('01','11')+maiAll+tlv('52','0000')+tlv('53','764')+tlv('54',amount.toFixed(2))+tlv('58','TH')+tlv('59','-')+tlv('60','Bangkok')+'6304';
      return payload+crc16(payload);
    }

    // ===== EmailJS init =====
    (function(){
      if(!window.emailjs){ console.warn('EmailJS not loaded'); return; }
      emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });
    })();

    // ===== Actions =====
    document.getElementById('btnBuyNow').addEventListener('click', ()=>{
      const f = document.getElementById('orderForm');
      f.reportValidity();
      if(f.checkValidity()){ submitOrder(); }
    });
    document.getElementById('btnPay').addEventListener('click', ()=>{
      const f = document.getElementById('orderForm');
      f.reportValidity();
      if(f.checkValidity()){ submitOrder(); }
    });

    async function submitOrder(){
      try{
        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const address = document.getElementById('address').value.trim();
        const qty = clampQty(parseInt(qtyEl.value||'1'));
        if(ENFORCE_STOCK && qty > INVENTORY){
          alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'); return;
        }
        const total = qty * UNIT_PRICE;

        // Generate PromptPay QR
        const account = (PROMPTPAY_USE==='nid') ? PROMPTPAY_NATIONAL_ID : PROMPTPAY_MOBILE;
        const payload = buildPromptPayPayload(account, total);
        const box = document.getElementById('qrcode'); box.innerHTML='';
        await new Promise((resolve,reject)=>{
          if(!window.QRCode){ reject(new Error('QRCode library not loaded')); return; }
          QRCode.toCanvas(document.createElement('canvas'), payload, (err, canvas)=>{
            if(err){ reject(err); return; }
            box.appendChild(canvas); resolve();
          });
        });

        // Send email via EmailJS
        if(!window.emailjs){ throw new Error('EmailJS not loaded'); }
        const order_id = makeOrderId();
        const vars = {
          to_email: EMAIL_TO,
          order_id,
          order_datetime: new Date().toLocaleString(),
          product_name: PRODUCT_NAME,
          quantity: qty,
          unit_price: UNIT_PRICE,
          items: total,
          shipping: 0,
          grand_total: total,
          name, phone, address, lang: 'th', freeship: true
        };
        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, vars);

        if(ENFORCE_STOCK){ INVENTORY -= qty; }
        salesToday += qty; document.getElementById('salesToday').textContent = salesToday;
        document.getElementById('ok').textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô';
        document.getElementById('ok').style.display = 'block';
        document.getElementById('err').style.display = 'none';
      }catch(e){
        document.getElementById('err').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ: ' + e.message;
        document.getElementById('err').style.display = 'block';
        document.getElementById('ok').style.display = 'none';
        console.error(e);
      }
    }
  </script>
</body>
</html>
